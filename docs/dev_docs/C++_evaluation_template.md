# C++ 代码质量评估报告

> **标准参考**:
> *   评估标准与工具指南请参考: [C++代码质量与评估标准指南](./C++_quality_standard.md)
> *   模块化最佳实践请参考: [C++20 Modules 大型工程实践](../C++/C++_20_模块-大型工程实践.md)

## 1. 评估概述

### 1.1 评估目标
> @brief 明确本次评估的主要目标和预期成果

- [ ] {评估目标1}
- [ ] {评估目标2}

### 1.2 评估对象信息

| 属性 | 内容 |
| :--- | :--- |
| **模块名称** | `{模块名称}` |
| **代码路径** | `{代码路径}` |
| **C++标准** | C++20 |
| **构建工具** | CMake + MSVC/Ninja |
| **负责人** | `{负责人}` |

---

## 2. 模块化与架构评估 (权重: 60%)

### 2.1 模块架构分析 (权重 20%)
> **标准**: "多模块聚合单库"原则。Library Target 数量应克制，Module 数量可细化。

| 检查项 | 评分点 | 状态 | 说明 | 证据来源 |
| :--- | :--- | :--- | :--- | :--- |
| **构建粒度** | 避免"一模块一 Target" | ✅ / ⚠️ / ❌ | 检查 CMakeLists.txt 是否聚合了多个 .ixx 到一个 add_library | `src/CMakeLists.txt` 中 FILE_SET cxx_modules 配置 |
| **分层架构** | 5层模型符合性 | ✅ / ⚠️ / ❌ | App -> Services -> Domain -> Platform -> Foundation | `src/app`, `src/services`, `src/domain`, `src/foundation` 目录结构验证 |
| **模块分类** | 模块类型正确 | ✅ / ⚠️ / ❌ | Public / Internal / Test 区分清晰 | grep 搜索 export/private 声明；检查 .test_support.ixx 文件 |
| **2层模型** | Logical vs Physical | ✅ / ⚠️ / ❌ | 逻辑模块与物理库的映射是否合理 | 对比 .ixx 文件数量 vs CMakeLists.txt 中 add_library 数量 |

### 2.2 接口设计与 BMI 优化 (权重 30%)
> **标准**: `.ixx` 仅包含声明，`.cpp` 包含实现。修改 `.cpp` 不应触发下游重编。

| 检查项 | 评分点 | 状态 | 说明 | 证据来源 |
| :--- | :--- | :--- | :--- | :--- |
| **接口纯度** | 接口与实现分离 | ✅ / ⚠️ / ❌ | `.ixx` 中是否存在非模板函数的函数体？ | 在 {module}.ixx 中搜索 `{` 符号（排除模板定义） |
| **GMF 使用** | 第三方库隔离 | ✅ / ⚠️ / ❌ | `#include` 是否放在 `module;` ... `export module` 之间？ | 检查 {module}.ixx 前 5 行是否包含 `module;` 和 `export module` 顺序 |
| **BMI 优化** | 增量构建友好 | ✅ / ⚠️ / ❌ | 修改 .cpp 是否触发了不必要的重编？ | 执行 `python build.py --action build` 两次，记录第二次编译涉及的文件 |
| **接口文档** | 完整性 | ✅ / ⚠️ / ❌ | 导出的类/函数是否有 Doxygen 注释？ | `grep -c "/// @brief" {module}.ixx` 与导出符号数量对比 |

### 2.3 依赖分析 (权重 10%)

| 检查项 | 评分点 | 状态 | 说明 | 证据来源 |
| :--- | :--- | :--- | :--- | :--- |
| **依赖单向性** | 无反向依赖 | ✅ / ⚠️ / ❌ | 底层模块不依赖高层模块 | 检查 Foundation, Platform, Domain, Services 各层的 CMakeLists.txt target_link_libraries |
| **循环依赖** | 无循环引用 | ✅ / ⚠️ / ❌ | Ninja/CMake 未报告 Cycle | `python build.py --action configure` 输出，查找 "circular" 关键字 |
| **依赖清晰度** | 依赖矩阵完整 | ✅ / ⚠️ / ❌ | 依赖关系是否直观清晰 | 绘制模块依赖图，与计划中的 Mermaid 图对比 |

**典型违规代码片段 (如有)**:
```cpp
// 粘贴发现的违规代码，如在 .ixx 中直接写了实现
```

### 2.4 自动化工具审计 (权重: 权重已分配到 2.1-2.3)
> **目的**: 收集自动化工具的审计结果，作为上述人工检查的补充证据。

| 工具 | 检查内容 | 运行命令 | 结果说明 |
| :--- | :--- | :--- | :--- |
| **Clang-Tidy** | 静态分析与代码风格 | `python scripts/run_clang_tidy.py` | 记录：高危警告数 / 中危数 / 低危数 |
| **CMake 依赖图** | 循环依赖与反向依赖检测 | `cmake --graphviz=graph.dot; dot -Tpng graph.dot -o graph.png` | 生成的依赖图是否形成环或违反分层？ |
| **编译器警告** | MSVC 严格警告检查 | `python build.py --action build 2>&1 \| grep "warning:"` | 是否有未解决的警告？ |
| **格式检查** | 代码风格合规性 | `python scripts/format_code.py --check {file}` | diff 输出（若为空则通过）|
| **测试覆盖** | 单元测试覆盖率 | `python build.py --action test` | 总体覆盖率 / 关键模块覆盖率 |

---

## 3. 代码质量与规范评估 (权重: 30%)

### 3.1 代码风格与规范 (权重 10%)
> **参考**: 原 C++_code_style.md 规范

| 检查项 | 规范要求 | 状态 | 说明 | 证据来源 |
| :--- | :--- | :--- | :--- | :--- |
| **命名规范** | `snake_case` | ✅ / ⚠️ / ❌ | 变量、函数、命名空间使用蛇形命名 | 随机抽样 5 个函数名，检查是否符合 snake_case |
| **成员变量** | `m_` 前缀 + `snake_case` | ✅ / ⚠️ / ❌ | 类成员变量需带 `m_` 前缀 | `grep "\s[a-z_][a-zA-Z_]*;" {module}.ixx` 检查成员声明 |
| **注释风格** | Doxygen 风格 | ✅ / ⚠️ / ❌ | 核心接口使用 `/// @brief` 等标签 | `grep -c "/// @" {module}.ixx` 统计文档注释 |
| **格式化** | Clang-Format | ✅ / ⚠️ / ❌ | 代码是否经过格式化工具处理 | 执行 `python scripts/format_code.py {file}` 并检查 diff |

### 3.2 安全性与现代化 (权重 20%)

| 检查项 | 评分点 | 状态 | 说明 | 证据来源 |
| :--- | :--- | :--- | :--- | :--- |
| **内存安全** | RAII / 智能指针 | ✅ / ⚠️ / ❌ | 禁止裸 `new/delete`，优先使用 `std::unique_ptr` | `grep -n "new\|delete" {module}.cpp` 检查是否存在裸指针分配 |
| **资源管理** | Rule of 5 | ✅ / ⚠️ / ❌ | 需自定义析构函数的类是否正确处理了拷贝/移动语义 | 检查包含析构函数的类是否定义了拷贝/移动构造函数与赋值运算符 |
| **现代特性** | C++20 特性使用 | ✅ / ⚠️ / ❌ | 是否使用了 Concepts, Ranges, Modules 等新特性 | `grep -E "concept\|requires\|co_\|std::ranges" {module}.ixx` 统计使用情况 |
| **线程安全** | 并发控制 | ✅ / ⚠️ / ❌ | 多线程访问是否有锁或原子操作保护 | 检查全局变量和共享状态是否有 mutex/atomic 保护 |
| **异常安全** | 异常保证 | ✅ / ⚠️ / ❌ | 关键路径是否提供了基本或强异常保证 | 代码审查关键函数（如析构、内存分配）的异常处理 |

---

## 4. 测试与性能评估 (权重: 10%)

### 4.1 测试隔离与覆盖 (权重 5%)

| 检查项 | 评分点 | 状态 | 说明 | 证据来源 |
| :--- | :--- | :--- | :--- | :--- |
| **测试隔离** | 独立模块 | ✅ / ❌ | 生产代码是否零依赖于测试代码？ | grep 搜索生产代码是否引用 test_* 或 .test_support 模块 |
| **测试辅助** | `test_support` | ✅ / ❌ | 测试辅助工具是否独立封装？ | 检查 {module}.test_support.ixx 是否存在且与生产模块分离 |
| **测试覆盖** | 覆盖率 | {数值}% | 单元测试覆盖率情况 | 执行 `python build.py --action test` 查看测试输出报告 |

### 4.2 性能评估 (权重 5%)

| 检查项 | 评分点 | 状态 | 说明 | 证据来源 |
| :--- | :--- | :--- | :--- | :--- |
| **编译性能** | 编译时间 | ✅ / ⚠️ | BMI 生成和编译速度是否在可接受范围？ | `python build.py --action build` 输出的总耗时；与 baseline 对比 |
| **运行时性能**| 关键路径 | ✅ / ⚠️ | 是否有明显的性能瓶颈？ | 压力测试结果 / profiler 热点分析 |

---

## 5. 评估结论与评分

### 5.1 评分汇总表
> 评分计算请参考 [C++质量标准指南](../C++_quality_standard.md#2-评分标准)

| 评估维度 | 权重 | 得分 (0-100) | 加权分 | 简评 |
| :--- | :--- | :--- | :--- | :--- |
| **模块化与架构** | 60% | | | {简述} |
| **代码质量与规范** | 30% | | | {简述} |
| **测试与性能** | 10% | | | {简述} |
| **总分** | **100%** | | **{总分}** | **{等级: 优秀/良好/合格/待改进}** |

### 5.2 改进计划 (Action Items)

**必须修复 (Blocker)**:
- [ ] {任务1}

**建议优化 (Nice to have)**:
- [ ] {任务2}

### 5.3 评估反馈与计划调整

> 若发现重大架构缺陷或规范偏离，需创建新 Task 链接至原计划。

**关键缺陷反馈**:
- [ ] {缺陷1} → 创建对应 Task [链接](../plan/{name}/task/C++_task_{title}.md) 或更新计划 [链接](../plan/C++_plan_{title}.md)
- [ ] {缺陷2} → 优先级: {High/Medium/Low}，目标完成时间: {日期}

**量化改进指标**:
- 覆盖率目标: {目前}% → {目标}% （完成时间: {日期}）
- 编译时间: {目前}s → {目标}s （通过优化: {具体措施}）

---
**评估人**: {姓名}
**日期**: {YYYY-MM-DD}
**关联任务**: [{任务链接}](../plan/{name}/task/C++_task_{title}.md)
**关联计划**: [{计划链接}](../plan/C++_plan_{title}.md)
