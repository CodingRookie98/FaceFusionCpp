name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build & Package (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04, ubuntu-22.04, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install LLVM 21 (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "21"
          env: true

      - name: Setup CUDA
        uses: Jimver/cuda-toolkit@v0.2.21
        with:
          cuda: '12.6.0'

      - name: Install cuDNN & TensorRT (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
          sudo dpkg -i cuda-keyring_1.1-1_all.deb
          sudo apt-get update
          sudo apt-get install -y libcudnn9-dev libcudnn9-cuda-12
          sudo apt-get install -y libnvinfer-dev libnvinfer10 libnvparsers-dev libnvparsers10 libnvonnxparsers-dev libnvonnxparsers10 libnvinfer-plugin-dev libnvinfer-plugin10
          echo "TensorRT_ROOT=/usr" >> $GITHUB_ENV
          echo "TENSORRT_ROOT=/usr" >> $GITHUB_ENV

      - name: Install cuDNN & TensorRT (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          # cuDNN
          $url = "https://developer.download.nvidia.com/compute/cudnn/redist/cudnn/windows-x86_64/cudnn-windows-x86_64-9.19.0.56_cuda12-archive.zip"
          $output = "cudnn.zip"
          Write-Host "Downloading cuDNN from $url"
          try {
            Invoke-WebRequest -Uri $url -OutFile $output -ErrorAction Stop
          } catch {
            Write-Error "Failed to download cuDNN: $_"
            exit 1
          }
          Expand-Archive -Path $output -DestinationPath .
          $cudnnDir = Get-ChildItem -Directory -Filter "cudnn-windows-x86_64-*" | Select-Object -First 1
          $cudaPath = $env:CUDA_PATH
          Copy-Item -Path "$($cudnnDir.FullName)\bin\*" -Destination "$cudaPath\bin" -Force
          Copy-Item -Path "$($cudnnDir.FullName)\include\*" -Destination "$cudaPath\include" -Force
          Copy-Item -Path "$($cudnnDir.FullName)\lib\x64\*" -Destination "$cudaPath\lib\x64" -Force

          # TensorRT
          $url = "https://developer.nvidia.com/downloads/compute/machine-learning/tensorrt/10.7.0/zip/TensorRT-10.7.0.23.Windows.win10.cuda-12.6.zip"
          $output = "TensorRT.zip"
          Write-Host "Downloading TensorRT from $url"
          try {
            Invoke-WebRequest -Uri $url -OutFile $output -ErrorAction Stop
          } catch {
            Write-Error "Failed to download TensorRT: $_"
            exit 1
          }
          Expand-Archive -Path $output -DestinationPath .
          $trDir = Get-ChildItem -Directory -Filter "TensorRT-*" | Select-Object -First 1
          $trPath = $trDir.FullName
          echo "TensorRT_ROOT=$trPath" >> $env:GITHUB_ENV
          echo "TENSORRT_ROOT=$trPath" >> $env:GITHUB_ENV
          echo "$trPath\lib" >> $env:GITHUB_PATH
          echo "$trPath\bin" >> $env:GITHUB_PATH

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11

      - name: Build & Package
        run: python build.py --action package --config Release --enable-gpu

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.os }}
          path: |
            build/**/*.zip
            build/**/*.tar.gz
            build/**/*.7z

  publish:
    name: Publish Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
