name: CI

on:
  push:
    branches: [ "master", "main", "dev", "**dev" ]
  pull_request:
    branches: [ "master", "main", "dev" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-linux:
    name: Build (Linux - ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04, ubuntu-22.04]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install LLVM 21
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "21"
          env: true

      - name: Check Formatting
        run: python scripts/format_code.py --check

      - name: Setup CUDA
        uses: Jimver/cuda-toolkit@v0.2.21
        with:
          cuda: '12.6.0'

      - name: Install cuDNN & TensorRT (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y libcudnn9-dev libcudnn9-cuda-12
          sudo apt-get install -y libnvinfer-dev libnvinfer10 libnvparsers-dev libnvparsers10 libnvonnxparsers-dev libnvonnxparsers10 libnvinfer-plugin-dev libnvinfer-plugin10
          echo "TensorRT_ROOT=/usr" >> $GITHUB_ENV
          echo "TENSORRT_ROOT=/usr" >> $GITHUB_ENV

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11

      - name: Configure
        run: python build.py --action configure --enable-gpu --enable-tests

      - name: Build
        run: python build.py --action build --enable-gpu --enable-tests

      - name: Test
        run: python build.py --action test --test-label unit --no-build --enable-gpu

  build-windows:
    name: Build (Windows)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup CUDA
        uses: Jimver/cuda-toolkit@v0.2.21
        with:
          cuda: '12.6.0'

      - name: Install cuDNN & TensorRT (Windows)
        shell: pwsh
        run: |
          # cuDNN
          $cudnnVersion = "9.6.0.74"
          $url = "https://developer.download.nvidia.com/compute/cudnn/redist/cudnn/windows-x86_64/cudnn-windows-x86_64-$cudnnVersion`_cuda12-archive.zip"
          $output = "cudnn.zip"
          Write-Host "Downloading cuDNN from $url"
          Invoke-WebRequest -Uri $url -OutFile $output
          Expand-Archive -Path $output -DestinationPath .
          $cudnnDir = Get-ChildItem -Directory -Filter "cudnn-windows-x86_64-*" | Select-Object -First 1
          $cudaPath = $env:CUDA_PATH
          Copy-Item -Path "$($cudnnDir.FullName)\bin\*" -Destination "$cudaPath\bin" -Force
          Copy-Item -Path "$($cudnnDir.FullName)\include\*" -Destination "$cudaPath\include" -Force
          Copy-Item -Path "$($cudnnDir.FullName)\lib\x64\*" -Destination "$cudaPath\lib\x64" -Force

          # TensorRT
          $trVersion = "10.7.0.23"
          $cudaVersion = "12.6"
          $url = "https://developer.download.nvidia.com/compute/machine-learning/tensorrt/10.7.0/TensorRT-$trVersion.Windows.win10.cuda-$cudaVersion.zip"
          $output = "TensorRT.zip"
          Write-Host "Downloading TensorRT from $url"
          Invoke-WebRequest -Uri $url -OutFile $output
          Expand-Archive -Path $output -DestinationPath .
          $trDir = Get-ChildItem -Directory -Filter "TensorRT-*" | Select-Object -First 1
          $trPath = $trDir.FullName
          echo "TensorRT_ROOT=$trPath" >> $env:GITHUB_ENV
          echo "TENSORRT_ROOT=$trPath" >> $env:GITHUB_ENV
          echo "$trPath\lib" >> $env:GITHUB_PATH
          echo "$trPath\bin" >> $env:GITHUB_PATH

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11

      - name: Configure
        run: python build.py --action configure --enable-gpu --enable-tests

      - name: Build
        run: python build.py --action build --enable-gpu --enable-tests

      - name: Test
        run: python build.py --action test --test-label unit --no-build --enable-gpu
